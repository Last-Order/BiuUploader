"use strict";$(document).ready(function(){$.material.init();var a=function(a){return new Promise(function(b,c){function d(){var b=h*f,c=b+f>=a.size?a.size:b+f;j.readAsArrayBuffer(e.call(a,b,c))}var e=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,f=2097152,g=Math.ceil(a.size/f),h=0,i=new SparkMD5.ArrayBuffer,j=new FileReader;j.onload=function(a){i.append(a.target.result),h++,g>h?d():(console.timeEnd("MD5计算"),b(i.end()))},j.onerror=function(){console.warn("MD5计算出错")},console.time("MD5计算"),d()})},b=function(a){return new Promise(function(b,c){var d=new AV.Asset.fromFile(a),e={},f=["metadata","format"].map(function(a){return new Promise(function(b,c){d.once(a,function(c){e[a]=c,b()})})});console.time("获取信息用时"),Promise.all(f).then(function(){console.timeEnd("获取信息用时"),d.stop(),h.push(a),b(e)}),d.start()})},c=function n(){if(g.length>0){var c=g.shift();console.log("Now Processing: "+c.name),Promise.all([b(c),a(c)]).then(function(a){a[0].md5=a[1],l[c.name]=a[0],i.push(c),console.log(l),n(),d()})}},d=function(){if(i.length>0&&!j){var a=i.shift();$(".music-info").fadeIn("fast",function(){j=!0,$("#inputTitle").val(l[a.name].metadata.title||""),$("#inputArtist").val(l[a.name].metadata.artist||""),$("#inputAlbum").val(l[a.name].metadata.album||""),$(".music-info").data("file",a)})}else j||$(".music-info").fadeOut("fast")};$("#info-save").click(function(){var a=$(".music-info").data("file"),b=$("#inputTitle").val(),c=$("#inputArtist").val(),f=$("#inputAlbum").val(),g=$("#inputDesc").val();$(".upload").append($("<div>").addClass("list-group-item").append($("<div>").addClass("row-content").append($("<h4>").addClass("list-group-item-heading").text(b)).append($("<div>").addClass("progress").append($("<div>").addClass("progress-bar").css("width","0%"))))),m.push({file:a,title:b,artist:c,album:f,desc:g,DOM:$(".list-group-item").last()}),j=!1,console.log(m),d(),e()});var e=function(){if(!k&&m.length>0){var a=m.shift(),b=118,c="MKpyJfHVEPFsSijBudOaboYLUWkpbwkW",d=SparkMD5.hash(""+b+l[a.file.name].md5+a.title+a.artist+a.album+a.desc+c),e={uid:"118",filemd5:l[a.file.name].md5,title:a.title,singer:a.artist,album:a.album,remark:a.desc,sign:d,force:"1"};$.ajax({type:"POST",url:"https://api.biu.moe/Api/createSong ",data:e,dataType:"json",success:function(b){b.success===!0?f(a.file,b.token,l[a.file.name].md5,a.DOM):b.success===!1&&2===b.error_code&&console.log("撞车")}})}},f=function(a,b,c,d){var f=d.find(".progress-bar"),g=d.find("h4");console.log("Now Uploading : "+a.name);var h=new FormData;h.append("file",a),h.append("key",c),h.append("x:md5",c),h.append("token",b),$.ajax({type:"POST",url:"http://upload.qiniu.com/",data:h,xhr:function(){var a=$.ajaxSettings.xhr();return a.upload&&a.upload.addEventListener("progress",function(a){var b=a.loaded/a.total;f.css("width",100*b+"%")},!1),a},processData:!1,contentType:!1,beforeSend:function(){k=!0,g.css("color","#2591AB")},success:function(a){k=!1,console.log(a),g.css("color","#4FAD4A"),e()},error:function(a){console.log(a)}})},g=[],h=[],i=[],j=!1,k=!1,l={},m=[];$(".file-select").change(function(){i=[],j=!1,$(".music-info").fadeOut("fast");for(var a=0;a<$(".file-select")[0].files.length;a++){var b=$(".file-select")[0].files;g.push(b[a])}c()})});