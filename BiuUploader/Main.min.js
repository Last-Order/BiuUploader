"use strict";$(document).ready(function(){$.material.init();var a=function(a){return new Promise(function(b,c){function d(){var b=h*f,c=b+f>=a.size?a.size:b+f;j.readAsArrayBuffer(e.call(a,b,c))}var e=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,f=2097152,g=Math.ceil(a.size/f),h=0,i=new SparkMD5.ArrayBuffer,j=new FileReader;j.onload=function(a){i.append(a.target.result),h++,g>h?d():(console.timeEnd("MD5计算"),$("#load-file .progress-bar").width(0===$("#load-file .progress-bar").width()?"50%":"100%"),b(i.end()))},j.onerror=function(){console.warn("MD5计算出错")},console.time("MD5计算"),d()})},b=function(a){return new Promise(function(b,c){var d=new AV.Asset.fromFile(a);d.on("buffer",function(a){100===a&&(console.timeEnd("获取信息用时"),b())});var e={},f=["metadata","format"].map(function(a){return new Promise(function(b,c){d.once(a,function(c){e[a]=c,b()})})});console.time("获取信息用时"),Promise.all(f).then(function(){console.timeEnd("获取信息用时"),d.stop(),i.push(a),$("#load-file .progress-bar").width(0===$("#load-file .progress-bar").width()?"50%":"100%"),b(e)}),d.start()})},c=function o(){if(h.length>0){var c=h.shift();console.log("Now Processing: "+c.name),$("#load-file .progress-bar").width("0%"),Promise.all([b(c),a(c)]).then(function(a){m[c.name]=a[0]||{},m[c.name].md5=a[1],j.push(c),console.log(m),o(),d()})}},d=function(){if(j.length>0&&!k){var a=j.shift();$(".music-info").fadeIn("fast",function(){k=!0,$("#inputTitle").val(m[a.name].metadata&&m[a.name].metadata.title||$("#inputTitle").val()||""),$("#inputArtist").val(m[a.name].metadata&&m[a.name].metadata.artist||$("#inputArtist").val()||""),$("#inputAlbum").val(m[a.name].metadata&&m[a.name].metadata.album||$("#inputAlbum").val()||""),$(".music-info").data("file",a)})}else k||$(".music-info").fadeOut("fast")};$("#info-save").click(function(){var a=$(".music-info").data("file"),b=$("#inputTitle").val(),c=$("#inputArtist").val(),e=$("#inputAlbum").val(),g=$("#inputDesc").val();$(".upload").append($("<div>").addClass("list-group-item").append($("<div>").addClass("row-content").append($("<h4>").addClass("list-group-item-heading").text(b)).append($("<div>").addClass("progress").append($("<div>").addClass("progress-bar").css("width","0%"))))),n.push({file:a,title:b,artist:c,album:e,desc:g,DOM:$(".list-group-item").last(),force:0}),k=!1,console.log(n),d(),f()});var e=function(a){return $("<div>").addClass("list-group-item").append($("<div>").addClass("row-content").append($("<h4>").addClass("list-group-item-heading").html(a.title+" / <small>"+a.album+"</small>")).append($("<a>").addClass("btn").addClass("btn-primary").addClass("play").text("试听").data({sid:a.sid})))},f=function p(){if(!l&&n.length>0){var a=n.shift(),b="YOUR UID HERE",c="YOUR SECRET KEY HERE",d=SparkMD5.hash(""+b+m[a.file.name].md5+a.title+a.artist+a.album+a.desc+c),f={uid:b,filemd5:m[a.file.name].md5,title:a.title,singer:a.artist,album:a.album,remark:a.desc,sign:d,force:a.force};$.ajax({type:"POST",url:"https://api.biu.moe/Api/createSong ",data:f,dataType:"json",success:function(b){if(b.success===!0)g(a.file,b.token,m[a.file.name].md5,a.DOM);else if(b.success===!1)if(2===b.error_code){a.DOM.append($("<div>").addClass("conflict"));var c=a.DOM.find(".conflict");c.append($("<a>").addClass("btn").addClass("btn-warning").text("处理撞车")),c.find(".btn").click(function(){$(this).remove(),c.append($("<h3>").text("可能撞车的音乐列表")),b.result.map(function(a){c.append($("<div>").addClass("list-group").append(e(a))),c.find(".play").click(function(){$(this).after('<div><iframe src="http://biu.moe/Api/shareBox?sid='+$(this).data("sid")+'&autoPlay=1" frameborder="0" height="50"></iframe></div>')})}),c.append($("<a>").addClass("btn").addClass("btn-warning").addClass("force").text("不要拦我我要传")),$(".force").click(function(){n.push({file:a.file,title:a.title,artist:a.artist,album:a.album,desc:a.desc,DOM:a.DOM,force:1}),c.fadeOut("fast",function(){$(this).remove()}),p()})}),p()}else a.DOM.find("h4").css("color","#FF0000")}})}},g=function(a,b,c,d){var e=d.find(".progress-bar"),g=d.find("h4");console.log("Now Uploading : "+a.name);var h=new FormData;h.append("file",a),h.append("key",c),h.append("x:md5",c),h.append("token",b),$.ajax({type:"POST",url:"http://upload.qiniu.com/",data:h,xhr:function(){var a=$.ajaxSettings.xhr();return a.upload&&a.upload.addEventListener("progress",function(a){var b=a.loaded/a.total;e.css("width",100*b+"%")},!1),a},processData:!1,contentType:!1,beforeSend:function(){l=!0,g.css("color","#2591AB")},success:function(a){l=!1,g.css("color","#4FAD4A"),f()},error:function(a){console.log(a)}})},h=[],i=[],j=[],k=!1,l=!1,m={},n=[];$(".file-select").change(function(){j=[],k=!1,$(".music-info").fadeOut("fast");for(var a=0;a<$(".file-select")[0].files.length;a++){var b=$(".file-select")[0].files;h.push(b[a])}c()})});